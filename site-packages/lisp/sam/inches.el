(require 'sam-common)

(defun inches-print (list)
  "Pretty print the `inches-decimal-to-fraction' output."
  (let ((feet (nth 0 list)) (inches (nth 1 list))
	(frac (nth 2 list)) (denom (nth 3 list))
	str)
    (if (> feet 0)
	(setq str (format "%d' %d" feet inches))
      (setq str (format "%d" inches)))
    (when (> frac 0)
      (setq str (concat str (format " %d/%d" frac denom))))
    (message "%s\"" str)))

;;;###autoload
(defun inches-decimal-to-fraction (arg inches)
  "When called interactively, asks for inches as a decimal and prints
as feet/inches/fraction. With a prefix-arg the fraction is 32ends,
else 16ths. When non-interactive returns a list '(feet inches fraction
denom)."
  (interactive "P\nnInches: ")
  (let* ((feet (floor (/ inches 12)))
	 (denom (if arg 32 16))
	 (frac (round (* (mod inches 1) denom)))
	 out)
    (when (> feet 0)
      (setq inches (- inches (* feet 12))))
    (setq inches (floor inches))
    (if (> frac 0)
	(while (eq (logand frac 1) 0)
	  (setq frac (/ frac 2))
	  (setq denom (/ denom 2)))
      (setq denom 0))
    (setq out (list feet inches frac denom))
    (when (my-interactive-p) (inches-print out))
    out))

;;;###autoload
(defun mm2inches (arg mm)
  "Print millimeters as inches. See `inches-decimal-to-fraction'."
  (interactive "P\nnmm: ")
  (inches-print (inches-decimal-to-fraction arg (* mm 0.0393701))))

;;;###autoload
(defun cm2inches (arg cm)
  "Print centimeters as feet/inches. See `inches-decimal-to-fraction'."
  (interactive "P\nncm: ")
  (mm2inches arg (* cm 10)))

;;;###autoload
(defun imperial2cm (feet inches)
  "Handy for converting feet + inches to cms for heights."
  (interactive "nfeet: \nninches: ")
  (let ((cm (* (+ (* feet 12) inches) 2.54)))
    (message "%dcm" cm)))

;;;###autoload
(defun m2inches (arg m)
  "Print meters as feet/inches. See `inches-decimal-to-fraction'."
  (interactive "P\nnm: ")
  (mm2inches arg (* m 1000)))
