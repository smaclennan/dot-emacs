(require 'etags)
(provide 'my-tags)

(defvar my-tag-prog "etags"
  "* The tag program executable to use.")
(defvar my-tag-c "*.c"
  "* Extension for C files, or any other files you want in the list.")
(defvar my-tag-h "*.h"
  "* Extension for header files, or any other files you want in the
list after `my-tag-c'.")
(defvar my-tag-sh "/bin/sh"
  "* Shell to use to run tags.")

(defvar my-tag-dir nil
  "* If set, this is the directory `my-tag-tree' should use.
This variable is buffer local.")
(make-variable-buffer-local 'my-tag-dir)

(defvar my-tag-buffers nil
  "* List of dirs and buffer names.")

;;;###autoload
(defun my-tag-tree (dir &optional buf)
  "Call tags on an entire tree rather than just one directory.
If buf is defined and is not empty, it is assumed to contain lines of
files to perform tags on."
  (interactive "DDir: ")
  (if buf
      (when (stringp buf) (setq buf (get-buffer-create buf)))
    (setq buf (get-buffer-create "*tag tree*"))
    ;; Emacs does not have (erase-buffer buf) :(
    (save-current-buffer (set-buffer buf) (erase-buffer)))

  (setq dir (expand-file-name dir))

  (when (eq (buffer-size buf) 0)
    ;; Doing the find in two steps seems to work better
    (call-process "find" nil (list buf nil) nil dir "-name" my-tag-c)
    (call-process "find" nil (list buf nil) nil dir "-name" my-tag-h))

  (with-current-buffer buf
    (call-process-region (point-min) (point-max)
			 my-tag-prog nil nil nil
			 "-o" (concat dir "TAGS") "-"))
    )

;;;###autoload
(defun my-tag-simple ()
  (call-process my-tag-sh nil nil nil "-c"
		(format "%s %s %s" my-tag-prog my-tag-c my-tag-h)))

;;;###autoload
(defun my-tag-dirs ()
  "Meant to be run from `after-save-hook'."
  (when my-tag-dir
    (let ((entry (assoc my-tag-dir my-tag-buffers)))
      (my-tag-tree my-tag-dir (when entry (nth 1 entry))))))

;;;###autoload
(defun my-tag-dirs-helper (dir &optional buf)
  "Helper function to setup a directory for use with `my-tag-dirs'."
  (setq my-tag-dir dir)

  (make-local-variable 'tags-file-name)
  (setq tags-file-name (concat dir "TAGS"))

  (when buf
    (add-to-list 'my-tag-buffers (list dir buf)))

  ;; Make sure the tags file exists
  (unless (file-exists-p tags-file-name)
    (message "Creating tags file...")
    (my-tag-dirs))

  (add-hook 'after-save-hook 'my-tag-dirs))

;;;###autoload
(defun my-tag-config ()
  (interactive)
  (require 'git-diff)
  (let ((git-dir (nth 1 (git-fname (buffer-file-name)))))
    (if (or tags-file-name my-tag-dir git-dir)
	(with-displaying-temp-buffer "*my-tag*"
	  (princ (format "File name: %S\n" (buffer-file-name)))
	  (princ (format "Tag file:  %S (%s)\n" tags-file-name
			 (if tags-file-name
			     (if (file-exists-p tags-file-name) "OK" "missing")
			   "nil")))
	  (princ (format "Tag dir:   %S\n" my-tag-dir))
	  (princ (format "Git dir:   %S\n" git-dir))
	  (princ (format "Compile:   %S\n" compile-command))
	  )
      (message "NIL"))))
