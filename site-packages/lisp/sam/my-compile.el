;;; my-compile.el - compile command helpers

;; Copyright (C) 1996-2011 Sean MacLennan

;; This program is free software; you can redistribute it and/or
;; modify it under the terms of the GNU General Public License version
;; 2 as published by the Free Software Foundation.

;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABIL`ITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with GNU Emacs; see the file COPYING.  If not, write to the
;; Free Software Foundation, Inc., 59 Temple Place - Suite 330,
;; Boston, MA 02111-1307, USA.

;; The 'car split-string' is a portable way to remove the trailing NL
(defvar my-kernel-vers (car (split-string (shell-command-to-string "uname -r")))
  "* Current kernel version.")

(defvar my-kernel-dir (file-chase-links (concat "/lib/modules/" my-kernel-vers "/build"))
  "* Current kernel directory.")

(defun my-kernel-set-dir (dir)
  "Set `my-kernel-dir' verifying that the directory exists and following all links."
  (interactive "DKernel dir: ")
  (setq dir (file-chase-links (expand-file-name dir)))
  (unless (file-exists-p dir)
      (unless (y-or-n-p (concat dir " does not exist... set anyway? "))
	(error "Not set.")))
  (setq my-kernel-dir dir)
  (message "Kernel = %s" my-kernel-dir))

(defun my-kernel-set-version (version)
  "Set the `my-kernel-vers' and `my-kernel-dir' variables with validation."
  (interactive "sVersion: ")
  (my-kernel-set-dir (concat "/lib/modules/" version "/build"))
  (setq my-kernel-vers version))

(defvar make-j (if (fboundp 'cpuinfo-num-processors)
		   (format "-j%d" (* (cpuinfo-num-processors) 2))
		 "-j2") ;; resonable default
  "* -Jn value to pass to makes.")

(defvar my-compile-dir-list
  (list
   ;; 2.4 kernels need bzImage and modules for drivers
   (list "^/usr/src/linux-2.4[^/]*/" (concat make-j " bzImage modules") "linux")
   ;; 2.6 kernels just work
   (list "^/usr/src/linux[^/]*/" make-j "linux")
   (list "^/usr/src/git-2.6[^/]*/" make-j "linux")
   ;; Make sure current kernel dir is included
   (list (concat "^" my-kernel-dir "/") make-j "linux")
   ;; emacs needs gnu
   (list ".*/[sx]?emacs[^/]*/src/" make-j "gnu")
   (list ".*/[sx]?emacs[^/]*/" make-j "gnu"))
  "*A list of directory matches used by `my-compile-command' to set
the compile command.

Each match is a list, only the first element is required:

  * The first element is a regexp for the directory.
  * The second element is an arg string to pass to make.
  * The third element is either a string which defines the style to
    use, or a lisp function to call. The lisp function will be passed
    the directory matched and the target as parameters.

Only the first match is used so order is important.")

;; Needed for Emacs.
(eval-when-compile
  (require 'cl)
  (require 'cc-vars))

(defun my-compile-command ()
  "Set the compile command for the current file.
Go through the 'my-compile-dir-list' looking for a match.
If we match, the second element is an optional target and the
third argument is an optional function to call. The optional
function will be called after the compile command is set."
  (interactive)
  (let (dir arg func-or-style matched)
    (loop for list in my-compile-dir-list until matched do
      (when (string-match (car list) default-directory)
	(setq matched t)
	(setq dir  (match-string 0 default-directory)
	      arg  (nth 1 list)
	      func-or-style (nth 2 list))
	;; (message "=> %s %s" dir) ;; SAM DBG
	(set (make-local-variable 'compile-command)
	     (concat "make -C " dir " " arg))
	(cond
	 ((stringp func-or-style) (c-set-style func-or-style))
	 ((fboundp func-or-style) (funcall func-or-style dir arg)))))))

;; Make sure we are *after* my-c-mode-common-hook
(add-hook 'c-mode-common-hook 'my-compile-command 'append)

;; Some helpers

(defun indent-N (n tab-mode)
  "Helper function for the (space|tab)-indent-N helpers ;)"
  (setq indent-tabs-mode tab-mode)
  (setq c-basic-offset n)
  (setq tab-width n))

(defun space-indent-4 (dir arg) (indent-N 4 nil))

(defun tab-indent-4 (dir arg) (indent-N 4 t))

(defun space-indent-2 (dir arg) (indent-N 2 nil))

(defun tab-indent-2 (dir arg) (indent-N 2 t))

;; Add hooks before and after compile

(defvar my-compile-before-hooks nil
  "* Hook(s) to be run before compile command is executed.")

(defvar my-compile-after-hooks nil
  "* Hook(s) to be run after compile command is executed.")

(defadvice compile (around my-compile-run-hooks activate)
  (run-hooks 'my-compile-before-hooks)
  ad-do-it
  (run-hooks 'my-compile-after-hooks))

(provide 'my-compile)
