.SUFFIXES: .el .elc

EMACS ?= emacs

CWD := $(shell pwd)
SUBDIR := $(shell basename $(CWD))

ifneq ($(findstring xemacs,$(EMACS)),)
EXTRA += auto-autoloads.el
EXTRA += custom-load.el
VERSION := $(shell $(EMACS) -V -vanilla | cut -d' ' -f2)

# This works well but has the side-effect that at least one line must
# get printed or it is considered an error.
BFILTER = grep -Ev -e "^(Wrote|Done|  Loading)" -e "^$$"
GFILTER = grep -Ev -e "^(No autoloads|Generating autoloads)" -e "^$$"

.el.elc:
	@$(EMACS) -batch -q -f batch-byte-compile $< 2>&1 | $(BFILTER)

else
HELPER := --eval "(setq load-path (append load-path '(\"~/.emacs.d/esp\" \".\")))"
EXTRA += elcs
EXTRA += $(SUBDIR)-loaddefs.el

.el.elc:
	@echo Building $<...
	@$(EMACS) -batch -q $(HELPER) -f batch-byte-compile $< 2>&1
endif

all:	$(EXTRA)

elcs:	$(LISP:.el=.elc)

auto-autoloads.el: $(LISP)
	@rm -f auto-autoloads.el
	@echo "XEmacs $(VERSION)"
ifeq ($(EMACS),sxemacs)
	@$(EMACS) -batch -f batch-create-autoloads . 2>&1 | $(GFILTER)
else
  ifeq ($(VERSION),21.4)
	@$(EMACS) -batch -q -no-site-file -l autoload \
		-f batch-update-directory . 2>&1 | $(GFILTER)
  else
	@$(EMACS) -batch -q -no-site-file -l autoload \
		-f batch-update-directory-autoloads $(SUBDIR) . 2>&1 | $(GFILTER)
  endif
endif

custom-load.el: $(LISP)
	$(EMACS) -batch -vanilla -l cus-dep -f Custom-make-dependencies .

$(SUBDIR)-loaddefs.el: $(ELCS)
	@echo Create $(EMACS) $(SUBDIR)-loaddefs.el ...
	@$(EMACS) -batch -q $(HELPER) -l build-loaddefs.el -f build-loaddefs

tags:
	etags *.el

clean:
	rm -f *.elc auto-autoloads.el custom-load.el $(SUBDIR)-loaddefs.el TAGS *~
