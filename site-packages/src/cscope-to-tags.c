#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <assert.h>

int main(int argc, char *argv[])
{
	FILE *in = fopen("cscope.out", "r");
	FILE *out = fopen("cscope.tags", "w");
	if (!in) {
		perror("cscope.out");
		exit(1);
	}
	if (!out) {
		perror("cscope.tags");
		exit(1);
	}

	char line[1024], *end; // max seen about 300
	unsigned lineno = 0;

	// suck up the header
	if (!fgets(line, sizeof(line), in) || strncmp(line, "cscope ", 7)) {
		puts("Unable to read header");
		exit(1);
	}

	fprintf(out, "!@%s", line);

	int skip_global = 0, in_enum = 0;
	while (fgets(line, sizeof(line), in)) {
		int outit = 0;
		char *p = strchr(line, '\n');
		if (!p) {
			puts("Line too long");
			exit(1);
		}
		*p = 0;

		switch (*line) {
		case '0' ... '9':
			lineno = strtol(line, &end, 10);
			// This deals with a bug in cscope that treats dot
			// initializers as globals.
			while (*end == ' ' || *end == '{') ++end;
			skip_global = *end == '.';
			break;
		case '\t':
			switch (*(line + 1)) {
			case '@': // file
				if (*(line + 2) == 0)
					goto done;
				fprintf(out, "%s\n", line + 1);
				in_enum = 0;
				break;
			case '$': // function
			case 's': // struct
			case 'u': // union
			case '#': // define
			case 't': // typedef
				outit = 1;
				in_enum = 0;
				break;
			case 'e': // enum
				outit = 1;
				in_enum = 1;
				break;
			case 'g': // global var
				outit = skip_global == 0;
				break;
			case 'm': // struct/enum/union member
				outit = in_enum;
				// Hack for non-named enums.
				// If the name is uppercase, add it to the tags.
				if (outit == 0) {
					for (p = line + 2; isupper(*p) || isdigit(*p) || *p == '_'; ++p) ;
					outit = *p == 0;
				}
				break;
			case '`': // calls
			case '~': // include
			case '}': // end of func
			case ')': // end of define
			case 'c': // class
				in_enum = 0;
				break;
			default:
				assert(0);
			}
			break;
		}

		if (outit)
			fprintf(out, "%s\t%d\n", line + 1, lineno);
	}

done:
	if (ferror(in)) {
		puts("Error on input");
		exit(1);
	}
	if (ferror(out)) {
		puts("Error on ouput");
		exit(1);
	}
	fclose(in);
	fclose(out);

	return 0;
}

/*
 * Local Variables:
 * compile-command: "gcc -Wall -O2 cscope-to-tags.c -o cscope-to-tags"
 * End:
 */
