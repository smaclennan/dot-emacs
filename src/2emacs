#!/bin/sh

# Edit /usr/share/applications/emacs.desktop:
# change Exec=emacs to Exec=2emacs
# Edit ~/.local/share/applications/mimeapps.list

[ -n "$1" ] || { echo "2emacs what?"; exit 1; }

FILE=$1
if [ "$1" = "-name" ]; then
    [ -n "$2" ] || { echo "2emacs -name what?"; exit 1; }
    FILE=`find -name $2 | head -n1`
    [ -n "$FILE" ] || { echo "no file found"; exit 1; }
fi

FILE=`echo $FILE | cut -d: -f1`
N=`echo $FILE | awk -F: '{print $2}'`

if [ "$N" -eq "$N" ] 2>/dev/null; then
    ARG="+$N"
else
    unset ARG
fi

# This changed in 27.1
if [ -n "$XDG_RUNTIME_DIR" ]; then
    socket=$XDG_RUNTIME_DIR/emacs/server
else
    # dash and ksh do not have $UID
    [ -z "$UID" ] && UID=$(id -u)
    socket=/tmp/emacs$UID/server
fi

if [ -S $socket ]; then
    emacsclient -n $ARG $FILE
else
    emacs $ARG $FILE &
fi
